<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>National Cookbooks Map</title>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <!-- PapaParse for CSV loading -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div id="map"></div>

  <script>
    let map;
    let colorMap = {};

    // Load colors first, then init map
    function loadColors() {
      fetch("config/influence_colors.json")
        .then(res => res.json())
        .then(data => {
          colorMap = data;
          initMap();
        });
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 2,
        center: { lat: 20, lng: 0 },
      });

      // Load the CSV with coordinates
      Papa.parse("data/national_cookbooks_master.csv", {
        download: true,
        header: true,
        complete: function(results) {
          results.data.forEach(row => {
            const lat = parseFloat(row.latitude);
            const lng = parseFloat(row.longitude);
            if (!isNaN(lat) && !isNaN(lng)) {
              createMarker(row, lat, lng);
            }
          });
        }
      });

      addLegend(map);
    }

    function getColor(tags) {
  if (!tags) return colorMap["default"];
  const parts = tags.split(";").map(t => t.trim().toLowerCase());
  for (let p of parts) {
    if (colorMap[p]) return colorMap[p];
  }
  return colorMap["default"];
}


    function createMarker(row, lat, lng) {
      const marker = new google.maps.Marker({
        position: { lat, lng },
        map,
        title: row.title || "Cookbook",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 6,
          fillColor: getColor(row.influence_tags),
          fillOpacity: 0.9,
          strokeWeight: 1,
          strokeColor: "#333"
        }
      });

      const info = new google.maps.InfoWindow({
        content: `
          <strong>${row.title || "Cookbook"}</strong><br/>
          ${row.author || ""} (${row.year || ""})<br/>
          ${row.city || ""}, ${row.country || ""}<br/>
          <small>${row.notes || ""}</small>
        `
      });

      marker.addListener("click", () => info.open(map, marker));
    }

    function addLegend(map) {
      const legend = document.createElement('div');
      legend.style.background = 'white';
      legend.style.padding = '10px';
      legend.style.margin = '10px';
      legend.style.border = '1px solid #ccc';
      legend.innerHTML = `
        <strong>Legend</strong><br>
        <span style="color:${colorMap.household}">●</span> Household<br>
        <span style="color:${colorMap.compendium}">●</span> Compendium<br>
        <span style="color:${colorMap.professional}">●</span> Professional<br>
        <span style="color:${colorMap.codification}">●</span> Codification<br>
        <span style="color:${colorMap.translation}">●</span> Translation/Adaptation<br>
        <span style="color:${colorMap.renaissance}">●</span> Renaissance/Historical<br>
      `;
      map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
    }
  </script>

  <!-- Your Google Maps API key restored -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCuqqCBYfo-xsGFQizUewcW88UeWQLAtGU&callback=loadColors">
  </script>
</body>
</html>
